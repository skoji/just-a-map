# CLAUDE.md - just a map 開発ガイドライン

## プロジェクト概要

### アプリケーション名
**just a map** - リアルタイムで更新される以外は単なる地図

### 目的
バイク（オートバイ）のハンドルマウントで使用する、シンプルで実用的な地図アプリケーション。ナビゲーション機能は不要で、現在地の確認と基本的な地図操作に特化。

### 主要な課題解決
- 通常の地図アプリはすぐにスリープしてしまう
- 信号待ちでの複雑な操作は危険で困難
- 現在の住所を即座に確認したい
- シンプルで直感的な操作性が必要

## 技術要件

### 使用技術
- **フレームワーク**: SwiftUI
- **地図**: Apple純正のMapKit
- **最小対応iOS**: iOS 17.0以上（最新のMapKit機能を活用）

### 開発方針
- **TDD（Test-Driven Development）**: t-wada流のTDDを採用
  - 問題が発生した場合の修正でも必ずTDDを行うこと。
- **設計思想**: John Carmack（シンプルさと効率性）、Robert C. Martin（Clean Architecture）、Rob Pike（簡潔性）の思想を意識
- **ドキュメント**: iOS開発経験のないプログラマーが理解し、自力で開発できるレベルの説明を提供

## 段階的実装計画

### 段階1: 基本的な地図表示
**目標**: 現在位置を中心とした地図を表示し、位置の更新に追従する

**実装内容**:
- MapKitを使用した基本的な地図表示
- CoreLocationによる位置情報の取得
- 現在位置への自動追従
- 位置情報使用許可の適切な処理

**テスト対象**:
- LocationManagerの初期化と権限リクエスト
- 位置情報更新のコールバック
- 地図の中心座標更新ロジック

**学習ポイント**:
- SwiftUIの基本構造
- @StateObjectと@Publishedの役割
- iOS権限システムの理解

### 段階2: 現在位置の住所表示とスリープ防止
**目標**: 現在地の住所を常に表示し、アプリ使用中はスリープを防止

**実装内容**:
- 逆ジオコーディングによる住所取得
- 住所情報の見やすい表示
- UIApplication.shared.isIdleTimerDisabledによるスリープ防止
- フォアグラウンド/バックグラウンド状態の管理

**テスト対象**:
- ジオコーディングAPIのモック化
- 住所フォーマットの変換ロジック
- アプリライフサイクルイベントの処理

**学習ポイント**:
- 非同期処理とasync/await
- CLGeocoderの使用方法
- アプリのライフサイクル管理

### 段階3: 地図コントロールと表示モード切り替え
**目標**: 直感的な地図操作と表示カスタマイズ

**実装内容**:
- ズームレベルの調整（ピンチ操作＋ボタン）
- North Up / Heading Up の切り替え
- 地図表示モード（標準/ドライブ/航空写真）の切り替え
- 大きめのタップしやすいコントロールボタン
- （将来）音声コマンドによる操作

**テスト対象**:
- ズームレベル計算ロジック
- 地図回転の状態管理
- UI状態の永続化

**学習ポイント**:
- SwiftUIのジェスチャー処理
- UserDefaultsによる設定保存
- カスタムUIコンポーネントの作成

## 設計原則

### John Carmack的アプローチ
- **実用性重視**: 過度な抽象化を避け、動作する最小限のコードから始める
- **パフォーマンス**: バッテリー消費を最小限に抑える位置情報更新頻度の最適化

### Robert C. Martin的アプローチ
- **依存性の逆転**: LocationManagerプロトコルを定義し、テスト可能性を確保
- **単一責任原則**: 各クラス/構造体は明確な単一の責任を持つ
- **境界の明確化**: ビジネスロジックとUIを分離

### Rob Pike的アプローチ
- **シンプルさ**: 「シンプルであることは複雑であることよりも難しい」
- **明確性**: コードは書かれるよりも読まれることが多い
- **少ないほど豊か**: 機能を追加する前に、本当に必要か検討

## テスト戦略

### TDDサイクル
1. **Red**: 失敗するテストを書く
2. **Green**: テストを通す最小限の実装
3. **Refactor**: コードを改善（テストは通ったまま）

### テスト対象の優先順位
1. ビジネスロジック（位置情報処理、住所変換）
2. 状態管理（地図の設定、表示モード）
3. UI統合テスト（最小限に留める）

### モックとスタブ
- CLLocationManagerのモック化
- CLGeocoderのスタブ化
- UserDefaultsのインメモリ実装

## コード規約

### 命名規則
- **変数/関数**: camelCase
- **型**: PascalCase
- **定数**: 大文字スネークケース（必要に応じて）

### ファイル構成
```
JustAMap/
├── App/
│   └── JustAMapApp.swift
├── Views/
│   ├── ContentView.swift
│   ├── MapView.swift
│   └── AddressView.swift
├── Models/
│   ├── LocationManager.swift
│   └── AddressFormatter.swift
├── Services/
│   └── GeocodeService.swift
├── Extensions/
│   └── CLLocationCoordinate2D+Extensions.swift
└── Tests/
    ├── Models/
    ├── Services/
    └── TestDoubles/
```

## 実装時の注意事項

### Claude AIへの依頼方法
1. **段階を明確に指定**: 「段階1の基本的な地図表示を実装してください」
2. **TDDの実践**: 「まずLocationManagerのテストを書いてください」
3. **説明の要求**: 「このコードの各部分について、iOS初心者向けに説明してください」

### よくある質問への準備
- 「@StateObjectと@ObservedObjectの違いは？」
- 「なぜプロトコルを使うのか？」
- 「async/awaitはどう動作するのか？」

## 将来の拡張予定

### 設定画面
- デフォルトズームレベル
- 地図の種類の初期設定
- 住所表示のフォーマット選択

### 音声操作
- 「ズームイン/アウト」
- 「ノースアップ/ヘディングアップ」
- 「標準地図/航空写真」

### その他（将来的に）
- Apple Watchとの連携
- CarPlay対応

## エラーハンドリング戦略

### 位置情報取得エラー
- **権限拒否時**: 設定画面への誘導メッセージを表示、地図は日本全体を表示
- **位置情報取得失敗**: 最後の既知の位置を使用、エラーアイコンを控えめに表示
- **精度が低い場合**: 精度インジケーターを表示（半透明の円で精度範囲を視覚化）

### ネットワークエラー
- **地図タイル読み込み失敗**: キャッシュされたタイルを使用、オフライン表示を明示
- **ジオコーディング失敗**: 緯度経度を表示、リトライボタンを提供
- **タイムアウト**: 3秒でタイムアウト、自動リトライは最大3回まで

### エラーメッセージの原則
- バイク走行中でも読みやすい大きな文字
- 技術的な詳細は避け、ユーザーが取るべき行動を明示
- 自動的に消えるメッセージは最低5秒表示

## パフォーマンス指標

### バッテリー消費
- **目標**: 1時間の連続使用で15%以下のバッテリー消費
- **位置情報更新頻度**: 
  - 高速移動時（60km/h以上）: 1秒ごと
  - 中速移動時（20-60km/h）: 2秒ごと
  - 低速/停止時（20km/h未満）: 5秒ごと
- **地図更新**: 有意な移動（10m以上）があった場合のみ

### メモリ使用量
- **上限**: 200MB（地図タイルキャッシュ含む）
- **キャッシュ戦略**: LRUで最大100MBまで地図タイルをキャッシュ
- **メモリ警告時**: 古いタイルから削除、最小50MBは維持

### 起動時間
- **コールドスタート**: 3秒以内に地図表示
- **権限確認**: 非ブロッキングで実行
- **前回の位置**: UserDefaultsに保存し、即座に表示

## UI/UXガイドライン

### タッチターゲット
- **最小サイズ**: 60x60ポイント（グローブ着用を考慮）
- **間隔**: ボタン間は最低20ポイント
- **配置**: 画面端から最低40ポイント内側（握り込み防止）

### 視認性
- **コントラスト比**: 最低7:1（WCAG AAA準拠）
- **文字サイズ**: 
  - 住所表示: 24ポイント以上
  - ボタンラベル: 20ポイント以上
- **色使い**: 色のみに依存しない（形状やアイコンも併用）

### 日光下での使用
- **明るさ自動調整**: 環境光センサーと連動
- **高コントラストモード**: 直射日光下では自動的に切り替え
- **反射防止**: 重要な情報は画面中央に配置

### 振動対策
- **デバウンス**: タップは100ms以上の長押しで確定
- **スワイプ無効化**: 意図しない操作を防ぐため、重要な操作はボタンのみ
- **確認不要**: 全ての操作は即座に実行（取り消し可能な操作に限定）

## デバッグとログ戦略

### ログレベル
```swift
enum LogLevel {
    case verbose  // 開発時のみ：全ての位置情報更新
    case debug    // デバッグビルド：主要なイベント
    case info     // リリースビルド：起動、権限変更
    case error    // 常時：エラーのみ
}
```

### クラッシュレポート
- **Crashlytics統合**: 基本的なクラッシュ情報のみ送信
- **個人情報除外**: 位置情報、住所は送信しない
- **オプトイン**: 初回起動時に許可を求める

### テスト用モック位置情報
```swift
// Debug builds only
let testScenarios = [
    "東京駅周辺走行",
    "山間部（GPS精度低下）",
    "トンネル通過（GPS喪失）",
    "高速道路走行"
]
```

## セキュリティとプライバシー

### 位置情報の取扱い
- **保存期間**: 現在位置のみ、履歴は保存しない
- **送信**: 外部サーバーへの送信は一切行わない
- **権限**: 「使用中のみ」で十分（常時追跡は不要）

### データ永続化
- **保存対象**: 
  - 最後の表示位置（緯度経度のみ）
  - UI設定（ズームレベル、地図タイプ）
- **保存しない**: 
  - 移動履歴
  - 検索履歴（検索機能自体がない）
  - 住所情報

### サードパーティ
- **使用ライブラリ**: Apple純正フレームワークのみ
- **広告/トラッキング**: 一切使用しない
- **アナリティクス**: 最小限（起動回数程度）、オプトアウト可能

## 参考リソース
- [Apple MapKit Documentation](https://developer.apple.com/documentation/mapkit/)
- [SwiftUI Tutorials](https://developer.apple.com/tutorials/swiftui)
- [t-wadaのTDD解説](https://gihyo.jp/dev/serial/01/tdd)
- [iOS Human Interface Guidelines](https://developer.apple.com/design/human-interface-guidelines/)

---

このドキュメントは生きたドキュメントとして、開発の進行に応じて更新されることを前提としています。
